# Ultralytics YOLO ğŸš€, AGPL-3.0 è®¸å¯è¯
# Argoverse-HD æ•°æ®é›†ï¼ˆç¯å‰ä¸­å¿ƒæ‘„åƒå¤´ï¼‰https://www.cs.cmu.edu/~mengtial/proj/streaming/ ç”± Argo AI æä¾›
# æ–‡æ¡£ï¼šhttps://docs.ultralytics.com/datasets/detect/argoverse/
# ç¤ºä¾‹ç”¨æ³•ï¼šyolo train data=Argoverse.yaml
# çˆ¶ç›®å½•
# â”œâ”€â”€ ultralytics
# â””â”€â”€ datasets
#     â””â”€â”€ Argoverse  â† ä¸‹è½½åˆ°æ­¤å¤„ (31.5 GB)

# è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†å¯ä»¥æ˜¯ 1) ç›®å½•ï¼špath/to/imgs, 2) æ–‡ä»¶ï¼špath/to/imgs.txt, æˆ– 3) åˆ—è¡¨ï¼š[path/to/imgs1, path/to/imgs2, ..]
path: ../datasets/Argoverse # æ•°æ®é›†æ ¹ç›®å½•
train: Argoverse-1.1/images/train/ # è®­ç»ƒå›¾åƒï¼ˆç›¸å¯¹äº 'path'ï¼‰39384 å¼ å›¾åƒ
val: Argoverse-1.1/images/val/ # éªŒè¯å›¾åƒï¼ˆç›¸å¯¹äº 'path'ï¼‰15062 å¼ å›¾åƒ
test: Argoverse-1.1/images/test/ # æµ‹è¯•å›¾åƒï¼ˆå¯é€‰ï¼‰https://eval.ai/web/challenges/challenge-page/800/overview

# ç±»åˆ«
names:
  0: person
  1: bicycle
  2: car
  3: motorcycle
  4: bus
  5: truck
  6: traffic_light
  7: stop_sign

# ä¸‹è½½è„šæœ¬/URLï¼ˆå¯é€‰ï¼‰---------------------------------------------------------------------------------------
download: |
  import json
  from tqdm import tqdm
  from ultralytics.utils.downloads import download
  from pathlib import Path

  def argoverse2yolo(set):
      labels = {}
      a = json.load(open(set, "rb"))
      for annot in tqdm(a['annotations'], desc=f"Converting {set} to YOLOv5 format..."):
          img_id = annot['image_id']
          img_name = a['images'][img_id]['name']
          img_label_name = f'{img_name[:-3]}txt'

          cls = annot['category_id']  # å®ä¾‹ç±»åˆ«ID
          x_center, y_center, width, height = annot['bbox']
          x_center = (x_center + width / 2) / 1920.0  # åç§»å’Œç¼©æ”¾
          y_center = (y_center + height / 2) / 1200.0  # åç§»å’Œç¼©æ”¾
          width /= 1920.0  # ç¼©æ”¾
          height /= 1200.0  # ç¼©æ”¾

          img_dir = set.parents[2] / 'Argoverse-1.1' / 'labels' / a['seq_dirs'][a['images'][annot['image_id']]['sid']]
          if not img_dir.exists():
              img_dir.mkdir(parents=True, exist_ok=True)

          k = str(img_dir / img_label_name)
          if k not in labels:
              labels[k] = []
          labels[k].append(f"{cls} {x_center} {y_center} {width} {height}\n")

      for k in labels:
          with open(k, "w") as f:
              f.writelines(labels[k])


  # ä¸‹è½½ 'https://argoverse-hd.s3.us-east-2.amazonaws.com/Argoverse-HD-Full.zip'ï¼ˆå·²å¼ƒç”¨çš„ S3 é“¾æ¥ï¼‰
  dir = Path(yaml['path'])  # æ•°æ®é›†æ ¹ç›®å½•
  urls = ['https://drive.google.com/file/d/1st9qW3BeIwQsnR0t8mRpvbsSWIo16ACi/view?usp=drive_link']
  print("\n\nè­¦å‘Šï¼šå¿…é¡»æ‰‹åŠ¨ä¸‹è½½ Argoverse æ•°æ®é›†ï¼Œè‡ªåŠ¨ä¸‹è½½å°†æ— æ³•å·¥ä½œã€‚")
  print(f"è­¦å‘Šï¼šæ‰‹åŠ¨ä¸‹è½½ Argoverse æ•°æ®é›† '{urls[0]}' åˆ° '{dir}'ï¼Œç„¶åé‡æ–°è¿è¡Œæ‚¨çš„å‘½ä»¤ã€‚\n\n")
  # download(urls, dir=dir)

  # è½¬æ¢
  annotations_dir = 'Argoverse-HD/annotations/'
  (dir / 'Argoverse-1.1' / 'tracking').rename(dir / 'Argoverse-1.1' / 'images')  # å°† 'tracking' é‡å‘½åä¸º 'images'
  for d in "train.json", "val.json":
      argoverse2yolo(dir / annotations_dir / d)  # å°† Argoverse æ³¨é‡Šè½¬æ¢ä¸º YOLO æ ‡ç­¾
